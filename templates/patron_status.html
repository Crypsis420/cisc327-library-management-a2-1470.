{% extends "base.html" %}

{% block content %}
<h2>ðŸ‘¤ Patron Status</h2>

<form method="get" action="{{ url_for('catalog.patron_status') }}" style="margin-top: 10px; margin-bottom: 20px;">
  <div class="form-group">
    <label for="patron_id">Patron ID (6 digits)</label>
    <input
      type="text"
      id="patron_id"
      name="patron_id"
      inputmode="numeric"
      pattern="\d{6}"
      minlength="6"
      maxlength="6"
      required
      value="{{ patron_id or '' }}"
      placeholder="e.g., 123456"
    >
  </div>
  <button class="btn btn-success" type="submit">View Status</button>
</form>

{% if report %}
  {% if report.status and report.status != 'ok' %}
    <div class="flash-error">{{ report.status }}</div>
  {% endif %}

  <div style="display:flex; gap:16px; flex-wrap:wrap; margin: 10px 0 20px 0;">
    <div style="background:#f2f2f2; padding:12px 16px; border-radius:6px;">
      <strong>Patron ID:</strong> {{ report.patron_id }}
    </div>
    <div style="background:#f2f2f2; padding:12px 16px; border-radius:6px;">
      <strong>Books Borrowed:</strong> {{ report.borrowed_count }}
    </div>
    <div style="background:#f2f2f2; padding:12px 16px; border-radius:6px;">
      <strong>Total Late Fees:</strong> ${{ '%.2f' % report.total_late_fees }}
    </div>
  </div>

  <h3>Currently Borrowed</h3>
  {% if report.currently_borrowed and report.currently_borrowed|length > 0 %}
    <table>
      <thead>
        <tr>
          <th>Book ID</th>
          <th>Title</th>
          <th>Due Date</th>
          <th>Overdue Days</th>
          <th>Accrued Fee ($)</th>
        </tr>
      </thead>
      <tbody>
      {% for item in report.currently_borrowed %}
        <tr>
          <td>{{ item.book_id }}</td>
          <td>{{ item.title }}</td>
          <td>
            {{ item.due_date }}
            {% if item.overdue_days > 0 %}
              <span class="status-unavailable" style="margin-left:6px;">Overdue</span>
            {% else %}
              <span class="status-available" style="margin-left:6px;">On Time</span>
            {% endif %}
          </td>
          <td>{{ item.overdue_days }}</td>
          <td>{{ '%.2f' % item.accrued_fee }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No books currently borrowed.</p>
  {% endif %}

  {% if report.history and report.history|length > 0 %}
    <h3 style="margin-top:28px;">Borrowing History</h3>
    <table>
      <thead>
        <tr>
          <th>Book ID</th>
          <th>Title</th>
          <th>Borrowed</th>
          <th>Due</th>
          <th>Returned</th>
        </tr>
      </thead>
      <tbody>
      {% for h in report.history %}
        <tr>
          <td>{{ h.book_id }}</td>
          <td>{{ h.title }}</td>
          <td>{{ h.borrow_date or '' }}</td>
          <td>{{ h.due_date or '' }}</td>
          <td>{{ h.return_date or 'â€”' }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}
{% else %}
  <p>Enter a 6-digit Patron ID above to view status.</p>
{% endif %}
{% endblock %}x